<!DOCTYPE html>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
<html
        xmlns="http://www.w3.org/1999/xhtml"
        xmlns:th="https://www.thymeleaf.org"
        xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
>
<head>
  <meta charset="ISO-8859-1">
  <link th:href="@{/styles/cssandjs/normalize.css}" rel="stylesheet" />
  <link th:href="@{/styles/cssandjs/main.css}" rel="stylesheet" />
  <title>Student Survey</title>
</head>

<body>
<h1 align="center">Survey</h1>
<div>
  <h3 th:align="right" th:inline="text">Hello [[${#httpServletRequest.remoteUser}]]!</h3>
  <div th:align="right">
    <a th:align="right" href="#" th:href="@{/logout}">Log out</a>
  </div>
</div>
<form action="">
    <div th:each="question, iterstat: ${surveyQuestions}" style="border: thin solid #000000">

      <strong id="questionTitle" th:text="${question.questionTitle}"></strong>
      <p id="questionText" th:text="${question.questionText}"></p>

      <div th:if="${question.questionTypeText == 'Free text'}">
        <textarea id="textResponse" th:name="${iterstat.index+1}" cols="20" rows="10"></textarea>
      </div>

      <div th:if="${question.questionTypeText == 'Numeric'}">
        <input type="number" id="numericResponse" th:id="${iterstat.index+1}" th:name="${iterstat.index+1}" min="1" max="10">
      </div>

      <div th:if="${question.questionTypeText == 'Multiplle choice - choose multiple'}">
        <div th:each="optionText : ${question.optionText}">
          <input type="checkbox" id="MCCMResponse" th:text="${optionText}" th:name="${iterstat.index+1}+|X@Y${optionText}">
        </div>
      </div>

      <div th:if="${question.questionTypeText == 'Multiple choice - choose one'}">
        <select th:name="${iterstat.index+1}">
          <div th:each="optionText : ${question.optionText}">
            <option th:text="${optionText}" id="MCCOResponse" th:value="${optionText}" th:name="${iterstat.index+1}+|X@Y${optionText}"></option>
          </div>
        </select>
      </div>
    </div>
  <br>
  <br>
  <input type="submit" value="Submit Survey">
</form>
</body>
<script>
  function sendResponse() {
    var questionType = document.querySelector("select[name='question_type']").value;
    var questionTitle = document.querySelector("input[name='question_title']").value;
    var questionText = document.querySelector("input[name='question_text']").value;
    var formData = new FormData();
    console.log({questionText, questionTitle, questionType})
    formData.append("questionTitle", questionTitle)
    formData.append("questionType", questionType)
    formData.append("questionText", questionText)
    if (questionType == 2 || questionType == 3) {
      var questionChoiceText = [];
      var questionChoiceValue = [];
      $("input[name='choiceText[]']").each(function () {
        questionChoiceText.push($(this).val())
      });
      $("input[name='choiceValue[]']").each(function () {
        questionChoiceValue.push($(this).val())
      });
      console.log({questionChoiceText, questionChoiceValue})
      formData.append("questionChoiceText", questionChoiceText)
      formData.append("questionChoiceValue", questionChoiceValue)

    }
    fetch("/add_question", {
      method: "POST",
      body: formData,
    }).then(r => r.json()).then(r => {
      if(r['success']){
        alert("Question Added");
        location.reload();
      }else{
        alert("Failed to insert question")
        location.reload();
      }
    });
  }
</script>
</html>